local lib = require("primordial/Player state library.641")
local enable2 = menu.add_checkbox("Def Spin", "Enable")
local enable3 = menu.add_checkbox("Def Spin", "only when vis - Buggy")
local selection2 = menu.add_multi_selection("Def Spin", "Def Spin When", {"Standing", "Running", "Slowwalk", "Crouch", "Jump", "Jump-Crouch"})
local slider2 = menu.add_slider("Def Spin", "Spin Speed", 1, 100)
local slider3 = menu.add_slider("Def Spin", "Velocity threshold", 0, 1000)


local max_charge = exploits.get_max_charge()
local cur_charge = exploits.get_charge()
local yaw_value = 180
local local_player = entity_list.get_local_player()
local velocity_history = {}
local last_velocity = 0
local yaw = menu.find("antiaim","main", "angles","yaw add")

local function are_have_weapon(ent)
    if not ent:is_alive() or not ent:get_active_weapon() then return end
    local t_cur_wep = ent:get_active_weapon():get_class_name()
    return t_cur_wep ~= "CKnife" and t_cur_wep ~= "CC4" and t_cur_wep ~= "CMolotovGrenade" and t_cur_wep ~= "CSmokeGrenade" and t_cur_wep ~= "CHEGrenade" and t_cur_wep ~= "CWeaponTaser"
end
local function are_them_visibles(ent)
    local local_p = entity_list:get_local_player()
    local generic_pos = ent:get_hitbox_pos(e_hitgroups.GENERIC)
    local left_arm_pos = ent:get_hitbox_pos(e_hitgroups.LEFT_ARM)
    local right_arm_pos = ent:get_hitbox_pos(e_hitgroups.RIGHT_ARM)
    if local_p:is_point_visible(generic_pos) or local_p:is_point_visible(left_arm_pos) or local_p:is_point_visible(right_arm_pos) then return true else return false end
end



local function on_setup_command()
    local local_player = entity_list.get_local_player()
    if not local_player or not local_player:is_alive() then
        return
    end

    local velocity = local_player:get_prop("m_vecVelocity"):length()
    velocity = math.floor(velocity + 0.5)

    table.insert(velocity_history, 1, velocity)
    if #velocity_history > 50 then
        table.remove(velocity_history, #velocity_history)
    end
end

local function spin()
    if globals.frame_count() % 2 * 1 == 0 or globals.frame_count() % 2 == 0 then
        yaw_value = yaw_value - slider2:get()
        if yaw_value < -180 then
            yaw_value = 180
        end
        
    end
end

function on_antiaim(ctx)
    local last_velocity = velocity_history[1] or 0
    local last_delta = last_velocity - (velocity_history[2] or 0)
    local player_state = lib.get_state()
    if enable2:get() then
        if player_state == 1 then
            if selection2:get(1)then
                if enable3:get()then
                    if ragebot.get_autopeek_pos() then return end
                    local enemies = entity_list.get_players(true)
                    if cur_charge > 12 and last_velocity > slider3:get()then
                        for i,v in ipairs(enemies) do
                            if are_them_visibles(v) and are_have_weapon(v) then
                                ctx:set_yaw(yaw_value)
                                ctx:set_pitch(0)
                            else
                                ctx:set_yaw(0)
                            end
                        end
                    end
                else
                    if cur_charge > 12 and last_velocity > slider3:get() then
                        ctx:set_yaw(yaw_value)
                        ctx:set_pitch(0)
                    else
                        ctx:set_yaw(0)
                    end
                end
            end
        elseif player_state == 2 then
            if selection2:get(2)then
                if enable3:get()then
                    if ragebot.get_autopeek_pos() then return end
                    local enemies = entity_list.get_players(true)
                    if cur_charge > 12 and last_velocity > slider3:get()then
                        for i,v in ipairs(enemies) do
                            if are_them_visibles(v) and are_have_weapon(v) then
                                ctx:set_yaw(yaw_value)
                                ctx:set_pitch(0)
                            else
                                ctx:set_yaw(0)
                            end
                        end
                    end
                else
                    if cur_charge > 12 and last_velocity > slider3:get() then
                        ctx:set_yaw(yaw_value)
                        ctx:set_pitch(0)
                    else
                        ctx:set_yaw(0)
                    end
                end
            end
        elseif player_state == 3 then
            if selection2:get(3)then
                if enable3:get()then
                    if ragebot.get_autopeek_pos() then return end
                    local enemies = entity_list.get_players(true)
                    if cur_charge > 12 and last_velocity > slider3:get()then
                        for i,v in ipairs(enemies) do
                            if are_them_visibles(v) and are_have_weapon(v) then
                                ctx:set_yaw(yaw_value)
                                ctx:set_pitch(0)
                            else
                                ctx:set_yaw(0)
                            end
                        end
                    end
                else
                    if cur_charge > 12 and last_velocity > slider3:get() then
                        ctx:set_yaw(yaw_value)
                        ctx:set_pitch(0)
                    else
                        ctx:set_yaw(0)
                    end
                end
            end
        elseif player_state == 4 then
            if selection2:get(4)then
                if enable3:get()then
                    if ragebot.get_autopeek_pos() then return end
                    local enemies = entity_list.get_players(true)
                    if cur_charge > 12 and last_velocity > slider3:get()then
                        for i,v in ipairs(enemies) do
                            if are_them_visibles(v) and are_have_weapon(v) then
                                ctx:set_yaw(yaw_value)
                                ctx:set_pitch(0)
                            else
                                ctx:set_yaw(0)
                            end
                        end
                    end
                else
                    if cur_charge > 12 and last_velocity > slider3:get() then
                        ctx:set_yaw(yaw_value)
                        ctx:set_pitch(0)
                    else
                        ctx:set_yaw(0)
                    end
                end
            end
        elseif player_state == 5 then
            if selection2:get(5)then
                if enable3:get()then
                    if ragebot.get_autopeek_pos() then return end
                    local enemies = entity_list.get_players(true)
                    if cur_charge > 12 and last_velocity > slider3:get()then
                        for i,v in ipairs(enemies) do
                            if are_them_visibles(v) and are_have_weapon(v) then
                                ctx:set_yaw(yaw_value)
                                ctx:set_pitch(0)
                            else
                                ctx:set_yaw(0)
                            end
                        end
                    end
                else
                    if cur_charge > 12 and last_velocity > slider3:get() then
                        ctx:set_yaw(yaw_value)
                        ctx:set_pitch(0)
                    else
                        ctx:set_yaw(0)
                    end
                end
            end
        elseif player_state == 6 then
            if enable3:get()then
                if ragebot.get_autopeek_pos() then return end
                local enemies = entity_list.get_players(true)
                if cur_charge > 12 and last_velocity > slider3:get()then
                    for i,v in ipairs(enemies) do
                        if are_them_visibles(v) and are_have_weapon(v) then
                            ctx:set_yaw(yaw_value)
                            ctx:set_pitch(0)
                        else
                            ctx:set_yaw(0)
                        end
                    end
                end
            else
                if cur_charge > 12 and last_velocity > slider3:get() then
                    ctx:set_yaw(yaw_value)
                    ctx:set_pitch(0)
                else
                    ctx:set_yaw(0)
                end
            end
        end
    end
end

callbacks.add(e_callbacks.ANTIAIM, on_antiaim)
callbacks.add(e_callbacks.SETUP_COMMAND, on_setup_command)
callbacks.add(e_callbacks.PAINT, function()
    spin()
end)